<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>אפרת מלכה</title>
   
</head>
<body>
    <link href="StyleSheet.css" rel="stylesheet" />
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>-->
    <!-- https://cdnjs.com/libraries/FileSaver.js -->
    <!-- https://github.com/eligrey/FileSaver.js -->
    <!--<script type="text/javascript" src="http://mydomain.com/xxxx.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>-->
    <script lang="javascript" src="xlsx.full.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" />
    <!--<script src="js/bootstrap.min.js"></script>-->
    <!--<script>
        document.addEventListener("keydown", (e) => {
            // USE THIS TO DISABLE CONTROL AND ALL FUNCTION KEYS
            //if (e.ctrlKey || (e.keyCode >= 112 && e.keyCode <= 123)) {
            // THIS WILL ONLY DISABLE CONTROL AND F12
            if (e.ctrlKey || e.keyCode == 123) {
                e.stopPropagation();
                e.preventDefault();
            }
        }
        );
    </script>


    <script>
        document.addEventListener("contextmenu", function (e) {
            e.preventDefault();
        }, false);
    </script>-->


    <script>

        var end = new Date(2023, 06, 08);
        var Today = new Date()
        if (Today < end) {
            var tasks = JSON.parse(localStorage.getItem("tasks"));
            var products = [{}];


            var counter = 0;
            var status = 0;
            var fullName;
            var grade;
            var lock;
            var sum = 0
            var returnval = 0;
            var results = ""
            var myObj;
            var taskResults = "";

            function sendToUpdate() {
                counter = 0;
                status = 0;
                lock = 1;
                var value = document.getElementById("barcode").value;
                document.getElementById("barcode").value = "";
                for (var i = 0; i < tasks.length; i++) {
                    if (tasks[i]["code"] == value) {
                        taskResults = tasks[i]
                    }
                }
                if (taskResults != "") {
                    updateTask();
                    return;
                }
                else
                    for (var i = 0; i < products.length; i++) {
                        if (products[i]["code"] == value) {
                            taskResults = products[i]
                        }
                    }

                if (taskResults == "") {
                    alert("קוד לא תקין, גשי למורה!")
                    reset(0);
                    status = 0;
                    return;
                }
                else
                    updateBuy()
            }

            function updateBuy() {
                savePoints(taskResults.points);
                if (returnval == 1)
                    return;
                document.getElementById("line1").innerHTML = "! המוצר נרכש בהצלחה ";
                document.getElementById("line2").innerHTML = "מיד תועברי להדפסת אישור";
                document.getElementById("gif").src = 'like.gif';
                toPrint(0);
            };
            function updateTask() {
                if (taskResults.code != "358312007" && taskResults.code != "358312008" && taskResults.code != "358312009" && taskResults.code != "358312010") {
                    if (results.tasksNumber.includes(taskResults.code)) {
                        alert("הי, אסור להגיש משימה פעמיים!");
                        reset(0);
                        status = 0;
                        return;
                    }
                }
                for (var i = 0; i < myObj.length; i++) {
                    if (myObj[i]["tz"] == results.tz) {
                        myObj[i].tasks += taskResults.name + ',';
                        myObj[i].tasksNumber += taskResults.code + ',';
                    }
                }

                savePoints(taskResults.points);
                document.getElementById("line1").innerHTML = "הידד" + "! " + "ביצעת את משימה" + " " + taskResults.name;
                document.getElementById("line2").innerHTML = "מיד תועברי להדפסת אישור";
                document.getElementById("gif").src = 'like.gif';
                toPrint(1);
            }

            function searchInExcel() {
                counter = 0;
                status = 1;
                var searchVal = document.getElementById("barcode").value;
                document.getElementById("barcode").value = "";
                myObj = JSON.parse(localStorage.getItem("students"));
                if (myObj == null) {
                    alert("לא הוזנו נתוני תלמידות, פני למורה!")
                    reset(0);
                    status = 0;
                    return;
                }
                for (var i = 0; i < myObj.length; i++) {
                    if (myObj[i]["tz"] == searchVal) {
                        results = myObj[i];
                    }
                }
                if (results == "") {
                    alert("את לא מופיעה ברשימות, גשי למורה !")
                    reset(0);
                    status = 0;
                    return;
                }
                fullName = results.first + "  " + results.last;
                grade = results.grade;
                document.getElementById("line1").innerHTML = "(: שלום  " + fullName;
                document.getElementById("line2").innerHTML = "סרקי את הברקוד לעדכון משימה";

            }

            document.addEventListener("keypress", function (e) {
                if (e.target.tagName !== "INPUT") {
                    var input = document.querySelector(".my-input");
                    input.focus();
                    input.value = e.key;
                    e.preventDefault();
                }
                counter += 1;

                if (counter > 9 && lock != 1) {
                    if (status == 0)
                        searchInExcel();
                    else
                        sendToUpdate();
                }
                if (lock == 1)
                    document.getElementById("barcode").value = "";


            });

            function reset(time) {
                setTimeout(function () {

                    document.getElementById("line1").innerHTML = "ברוכה הבאה ";
                    document.getElementById("line2").innerHTML = "העבירי את הכרטיס האישי שלך בסורק הברקוד";
                    document.getElementById("gif").src = 'barcode.gif';
                    document.getElementById("barcode").value = "";
                    lock = 0;
                    counter = 0;
                    results = "";
                    myObj = null;
                    taskResults = ""

                }, time);
            }

            function savePoints(points) {

                sum = parseInt(points) + parseInt(results.points);
                if (sum < 0) {
                    alert("אין לך מספיק נקודות בחשבון !")
                    reset(0);
                    status = 0;
                    returnval = 1;
                    return;
                }
                for (var i = 0; i < myObj.length; i++) {
                    if (myObj[i]["tz"] == results.tz) {
                        myObj[i].points = sum;
                    }
                }
                localStorage.setItem("students", JSON.stringify(myObj));

            }

            function toPrint(task) {
                var divName = "printableArea";
                setTimeout(function () {
                    document.getElementById("d1").innerHTML = fullName + " " + "מכיתה " + grade;
                    if (task == 1)
                        document.getElementById("d2").innerHTML = "     ביצעה את משימה" + " " + taskResults.name;
                    else
                        document.getElementById("d2").innerHTML = "     רכשה את מתנה " + " " + taskResults.name;

                    document.getElementById("d3").innerHTML = "     סך הנקודות בחשבון" + " :" + sum;

                    var printContents = document.getElementById(divName).innerHTML;
                    var originalContents = document.body.innerHTML;
                    document.body.innerHTML = printContents;
                    window.print();

                    document.body.innerHTML = originalContents;
                    document.getElementById("line1").innerHTML = "!כרגע יש לך בחשבון " + sum + " נקודות ";
                    document.getElementById("line2").innerHTML = "...אל תשכחי לקחת את האישור מהמדפסת";
                    reset(4000);
                }, 2000);
            }
        }
        else {
            alert("מצטערים.  פג תוקף הרשיון!")
        }

    </script>

    <!--<div id="printableArea" style="height:1px;color:transparent; border:solid;border-color:red;">
        <br /><br /><br /><br /><br /><br /><br />
        <br /><br /><br /><br /><br /><br /><br />
        <span style="font-size:60px; font-family: Fb Magnolia;z-index: -1;">אישור </span>
        <br /><br /><br />
        <div id="d1" style="font-size:30px; font-family: Fb Magnolia;font-weight:100"> </div>
        <div id="d2" style="font-size:30px; font-family: Fb Magnolia;font-weight:100"> </div>
        <div id="d3" style="font-size:30px; font-family: Fb Magnolia;font-weight:100"> </div>
        <br /><br /><br />
        <div id="d4" style="font-size:60px; font-family: Fb Magnolia;">בהצלחה בהמשך</div>
        <br /><br /><br /><br /><br /><br /> <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /> <br /><br /><br /><br /><br /><br />

        <div id="d5" style="font-size:20px; font-family: Fb Magnolia;">להזמנות: אפרת מלכה 0504167969 211efrat@gmail.com</div>
    </div>-->

    <div class="background1">
        <div class="background2">
            <div class="text">
                <div class="text1 fs-2"id="line1">ברוכה הבאה</div>
                <div class="text2" id="line2">העבירי את הכרטיס האישי שלך בסורק הברקוד</div>
                <img src="barcode.gif" class="gif" id="gif" />
            </div>
            <input type="text" class="my-input" id="barcode">
        </div>
    </div>
</body>
</html>

