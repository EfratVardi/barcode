<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ראשי</title>

</head>
<body onload="onload()">
    <link href="UserStyleSheet.css" rel="stylesheet" />
    <link href="MainStyleSheet.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        var end = new Date(2021, 06, 08);
        var Today = new Date()
        var tasksExcel = JSON.parse(localStorage.getItem("tasks"));
        var studentsExcel = JSON.parse(localStorage.getItem("students"));
        var uniqTasksExcel = JSON.parse(localStorage.getItem("uniqTasks"));
        var productsExcel = [{}];
        var searchVal
        var counter = 0;
        var lock;
        var studentResult = ""
        var result = "";
        var sum = 0
        var returnval = 0;
        if (Today < end) {

            function onload() {
                if (tasksExcel == null || studentsExcel == null || uniqTasksExcel == null) {
                    showAlert("לא הועלו כל הקבצים!")
                }
            }

            document.addEventListener("keypress", function (e) {
                if (e.target.tagName !== "INPUT") {
                    var input = document.querySelector(".my-input");
                    input.focus();
                    input.value = e.key;
                    e.preventDefault();
                }
                counter += 1;

                if (counter > 9 && lock != 1) {
                    searchVal = document.getElementById('barcode').value
                    counter = 0;
                    document.getElementById("barcode").value = "";
                    if (searchVal == '999999999')
                        login()
                    else if (searchVal.startsWith('1') || searchVal.startsWith('2') || searchVal.startsWith('3'))//כיתה או בת
                        searchInExcel();
                    else if (searchVal.startsWith('4'))//משימה חד פעמית
                        updateTask();
                    else if (searchVal.startsWith('5'))//משימה רגילה
                        updateUniqTask();
                    else if (searchVal.startsWith('6'))//מוצר
                        buyProduct();
                }
                if (lock == 1)
                    document.getElementById("barcode").value = "";
            });

            function login() {
                window.location.href = 'Manage.html';
            }

            function searchInExcel() {
                for (var i = 0; i < studentsExcel.length; i++) {
                    if (studentsExcel[i]["tz"] == searchVal) {
                        studentResult = studentsExcel[i];
                        break;
                    }
                }
                if (studentResult == "") {
                    showAlert("את לא מופיעה ברשימות. גשי למורה!")
                }
                document.getElementById("line1").innerHTML = "(: שלום  " + studentResult.name;
                document.getElementById("line2").innerHTML = "סרקי את הברקוד לעדכון משימה";
            }

            function updateTask() {
                lock = 1;
                if (searchVal.startsWith(4)) {
                    for (var i = 0; i < tasksExcel.length; i++) {
                        if (tasksExcel[i]["code"] == searchVal) {
                            result = tasksExcel[i]
                            break;
                        }
                    }
                    if (result != "") {
                        if (studentResult.tasksNumber.includes(result.code)) {
                            showAlert("הי, אסור להגיש משימה פעמיים!");
                        }

                        for (var i = 0; i < studentsExcel.length; i++) {
                            if (studentsExcel[i]["tz"] == studentResult.tz) {
                                studentsExcel[i].tasks += result.name + ',';
                                studentsExcel[i].tasksNumber += result.code + ',';
                                break;
                            }
                        }

                        savePoints(result.points);
                        document.getElementById("line1").innerHTML = "הידד" + "! " + "ביצעת את משימה" + " " + result.name;
                        document.getElementById("line2").innerHTML = "מיד תועברי להדפסת אישור";
                        document.getElementById("gif").src = 'like.gif';
                        toPrint(1);
                    }
                    else showAlert("קוד לא תקין, גשי למורה!")
                }
            }

            function updateUniqTask() {
                lock = 1;
                for (var i = 0; i < uniqTasksExcel.length; i++) {
                    if (uniqTasksExcel[i]["code"] == searchVal) {
                        result = uniqTasksExcel[i]
                        break;
                    }
                }
                if (result != "") {

                    if (result.class && !studentResult.code.startsWith(1)) {
                        showAlert("תלמידה לא יכולה לתקף משימה כיתתית!")
                    }

                     if (!result.class && studentResult.code.startsWith(1)) {
                        showAlert("כיתה לא יכולה לתקף משימה אישית!")
                    }

                    if (result.used == 1) {
                        showAlert("הי, כבר תיקפת משימה זו!");
                    }

                    for (var i = 0; i < studentsExcel.length; i++) {
                        if (studentsExcel[i]["tz"] == studentResult.tz) {
                            studentsExcel[i].tasks += result.name + ',';
                            studentsExcel[i].tasksNumber += result.code + ',';
                            break;
                        }
                    }
                    for (var i = 0; i < uniqTasksExcel.length; i++) {
                        if (uniqTasksExcel[i]["code"] == result.code) {
                            uniqTasksExcel[i].used = 1
                            break;
                        }
                    }
                    localStorage.setItem("uniqTasks", JSON.stringify(uniqTasksExcel));

                    savePoints(result.points);
                    document.getElementById("line1").innerHTML = "הידד" + "! " + "ביצעת את משימה" + " " + result.name;
                    document.getElementById("line2").innerHTML = "מיד תועברי להדפסת אישור";
                    document.getElementById("gif").src = 'like.gif';
                    toPrint(1);
                }
                else showAlert("קוד לא תקין, גשי למורה!")
            }

            function buyProduct() {
                lock = 1;

                if (searchVal.startsWith(6)) {
                    for (var i = 0; i < productsExcel.length; i++) {
                        if (productsExcel[i]["code"] == searchVal) {
                            result = productsExcel[i]
                            break;
                        }
                    }
                    if (result != "") {
                        savePoints(result.points);
                        if (returnval == 1)
                            return;
                        document.getElementById("line1").innerHTML = "! המוצר נרכש בהצלחה ";
                        document.getElementById("line2").innerHTML = "מיד תועברי להדפסת אישור";
                        document.getElementById("gif").src = 'like.gif';
                        toPrint(0);
                    }
                    else showAlert("קוד לא תקין, גשי למורה!")

                }

            };

            function savePoints(points) {

                sum = parseInt(points) + parseInt(studentResult.points);
                if (sum < 0) {
                    showAlert("אין לך מספיק נקודות בחשבון !")
                    returnval = 1;
                }
                for (var i = 0; i < studentsExcel.length; i++) {
                    if (studentsExcel[i]["tz"] == studentResult.tz) {
                        studentsExcel[i].points = sum;
                        break;
                    }
                }
                localStorage.setItem("students", JSON.stringify(studentsExcel));
            }

            function toPrint(task) {
                var divName = "printableArea";
                setTimeout(function () {
                    document.getElementById("d1").innerHTML = studentResult.name + " " + "מכיתה " + studentResult.grade;
                    if (task == 1)
                        document.getElementById("d2").innerHTML = "     ביצעה את משימה" + " " + result.name;
                    else
                        document.getElementById("d2").innerHTML = "     רכשה את מתנה " + " " + result.name;

                    document.getElementById("d3").innerHTML = "     סך הנקודות בחשבון" + " :" + sum;

                    var printContents = document.getElementById(divName).innerHTML;
                    var originalContents = document.body.innerHTML;
                    document.body.innerHTML = printContents;
                    window.print();

                    document.body.innerHTML = originalContents;
                    document.getElementById("line1").innerHTML = "!כרגע יש לך בחשבון " + sum + " נקודות ";
                    document.getElementById("line2").innerHTML = "...אל תשכחי לקחת את האישור מהמדפסת";
                    reset(4000);
                }, 2000);
            }

            function reset(time) {
                setTimeout(function () {

                    document.getElementById("line1").innerHTML = "ברוכה הבאה ";
                    document.getElementById("line2").innerHTML = "העבירי את הכרטיס האישי שלך בסורק הברקוד";
                    document.getElementById("gif").src = 'barcode.gif';
                    document.getElementById("barcode").value = "";
                    tasksExcel = JSON.parse(localStorage.getItem("tasks"));
                    studentsExcel = JSON.parse(localStorage.getItem("students"));
                    uniqTasksExcel = JSON.parse(localStorage.getItem("uniqTasks"));
                    products = [{}];
                    counter = 0;
                    lock = 0;
                    studentResult = ""
                    result = ""
                    sum = 0
                    returnval = 0;

                }, time);
            }
        }
        else { showAlert("מצטערים. פג תוקף הרשיון!") }

        function showAlert(message) {
            document.querySelector(".modal-body").innerHTML = message;
            $(document).ready(function () {
                $('#modal').modal('show')
            });
            setTimeout(function () {
                $(document).ready(function () {
                    $('#modal').modal('hide')
                });
            }, 3500);
            reset(0);
        }
    </script>

    <div id="printableArea" style="height:1px;color:transparent; border:solid;display:none">
        <br /><br /><br /><br /><br /><br /><br />
        <br /><br /><br /><br /><br /><br /><br />
        <span style="font-size:60px; font-family: Fb Magnolia;z-index: -1;">אישור </span>
        <br /><br /><br />
        <div id="d1" style="font-size:30px; font-family: Fb Magnolia;font-weight:100"> </div>
        <div id="d2" style="font-size:30px; font-family: Fb Magnolia;font-weight:100"> </div>
        <div id="d3" style="font-size:30px; font-family: Fb Magnolia;font-weight:100"> </div>
        <br /><br /><br />
        <div id="d4" style="font-size:60px; font-family: Fb Magnolia;">בהצלחה בהמשך</div>
        <br /><br /><br /><br /><br /><br /> <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /> <br /><br /><br /><br /><br /><br />

        <div id="d5" style="font-size:20px; font-family: Fb Magnolia;">להזמנות: אפרת מלכה 0504167969 211efrat@gmail.com</div>
    </div>
    <div class="background1">
        <div class="background2">

            <div class="text">
                <div class="text1" id="line1">ברוכה הבאה</div>
                <div class="text2" id="line2">העבירי את הכרטיס האישי שלך בסורק הברקוד</div>
                <img src="barcode.gif" class="gif" id="gif" />
            </div>
            <input type="text" class="my-input" id="barcode">
        </div>
    </div>
    <div class="modal fade" style="direction: rtl" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">הודעת מערכת</h5>
                </div>
                <div class="modal-body"> </div>
            </div>
        </div>
    </div>
</body>
</html>

